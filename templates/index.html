{% extends "base.html" %}
{% block content %}
{% if show_home %}
  <div class="hero">
    <h1 class="hero-title">Typing Lab</h1>
  </div>
  <div class="typing-stage typing-fullwidth">
    <div class="typing-content">
      <div id="homeTimer" class="home-timer hidden">
        <span id="timeLeft">{{ duration_seconds }}</span>s
      </div>
      <div class="duration-bar duration-row" data-duration-row>
        <button type="button" class="duration-pill" data-duration="15">15</button>
        <button type="button" class="duration-pill" data-duration="30">30</button>
        <button type="button" class="duration-pill" data-duration="60">60</button>
        <button type="button" class="duration-pill" data-duration="120">120</button>
      </div>
      <div class="typebox typing-vars typebox--home" id="homeTypebox">
        <div class="typebox-inner">
          <div id="ghost" class="ghost" aria-hidden="true" data-prompt="{{ prompt_text }}">{{ prompt_text }}</div>
          <textarea id="input" rows="3"></textarea>
        </div>
      </div>
      <div id="result" class="result hidden">
        <div class="result-grid">
          <canvas id="wpmChart" width="520" height="220"></canvas>
          <div class="result-stats">
            <div class="wpm-ring" id="wpmRing" style="--wpm-progress: 0; --wpm-color: #ef4444;">
              <span id="wpmValue">0</span>
              <div class="wpm-label">WPM</div>
            </div>
            <div class="accuracy-card">
              <div class="accuracy-value" id="accValue">0%</div>
              <div class="accuracy-label">Accuracy</div>
            </div>
          </div>
        </div>
        <button id="restartHome">Restart</button>
      </div>
    </div>
  </div>
  <div class="home-progress">
      <div class="home-progress-title">Your progress</div>
      <div class="home-progress-grid">
        <a class="progress-card progress-card--square" href="/training">
          <div class="progress-ring" id="homeTrainingProgressRing" style="--progress: 0;">
            <span class="progress-value" id="homeTrainingProgressValue">0%</span>
          </div>
          <div class="progress-text">Training completed</div>
        </a>
        <div class="progress-card progress-card--square">
          <div class="progress-ring progress-ring--plain">
            <span class="progress-value">{{ "%.1f"|format(user_best_wpm) if user_best_wpm is not none else "â€”" }}</span>
          </div>
          <div class="progress-text">Best WPM</div>
        </div>
        <div class="progress-card progress-card--square">
          <div class="progress-ring progress-ring--plain progress-ring--elo">
            <span class="progress-elo">{{ user_rating if user_rating is not none else 1500 }}</span>
          </div>
          <div class="progress-text">Current ELO</div>
        </div>
      </div>
    </div>
{% else %}
  <h1 class="ranked-title">Ranked Typing</h1>
  <div class="typing-stage typing-fullwidth">
    <div class="typing-content">
      <div id="testTimer" class="home-timer hidden">
        <span id="timeLeft">{{ duration_seconds }}</span>s
      </div>
      <p class="small"></p>

      <div id="testTypebox">
        <div class="duration-bar duration-row" data-duration-row>
          <button type="button" class="duration-pill" data-duration="15">15</button>
          <button type="button" class="duration-pill" data-duration="30">30</button>
          <button type="button" class="duration-pill" data-duration="60">60</button>
          <button type="button" class="duration-pill" data-duration="120">120</button>
        </div>
        <div class="typebox typing-vars typebox--test">
          <div class="typebox-inner">
            <div id="ghost" class="ghost" aria-hidden="true" data-prompt="{{ prompt_text }}">{{ prompt_text }}</div>
            <textarea id="input" rows="4"></textarea>
          </div>
        </div>

        <div class="row hidden" aria-hidden="true">
          <div class="stat">Time: <span id="timeLeft">{{ duration_seconds }}</span>s</div>
          <div class="stat">WPM: <span id="wpm">0</span></div>
          <div class="stat">Accuracy: <span id="acc">0</span>%</div>
        </div>
      </div>

      <p class="small muted" id="status"></p>

      <div id="result" class="result hidden">
        <div class="result-grid">
          <canvas id="wpmChart" width="520" height="220"></canvas>
          <div class="result-stats">
            <div class="wpm-ring" id="wpmRing" style="--wpm-progress: 0; --wpm-color: #ef4444;">
              <span id="wpmValue">0</span>
              <div class="wpm-label">WPM</div>
            </div>
            <div class="accuracy-card">
              <div class="accuracy-value" id="accValue">0%</div>
              <div class="accuracy-label">Accuracy</div>
            </div>
          </div>
        </div>
        <button id="restart">Restart</button>
      </div>

      <div class="row justify-start"></div>
    </div>
  </div>
{% endif %}

{% if ranked %}
  <div class="typing-stage typing-fullwidth">
    <div class="typing-content">
      <div class="card reward-card elo-panel">
        <h2>Current ELO</h2>
        <div class="elo-value" id="eloValue">{{ user_rating if user_rating is not none else 1500 }}</div>
        <div class="elo-delta" id="eloDelta"></div>
        <table class="elo-table">
          <thead>
            <tr><th>Rank</th><th>User</th><th>ELO</th></tr>
          </thead>
          <tbody>
            {% if elo_rankings and elo_rankings|length > 0 %}
              {% for row in elo_rankings %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ row.name if row.name else row.email }}</td>
                <td>{{ row.rating }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td>1</td>
                <td>{{ user_name }}</td>
                <td>{{ user_rating if user_rating is not none else 1500 }}</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}

<script id="typing-config" type="application/json">
  {{ {
    "durationSeconds": duration_seconds,
    "promptText": prompt_text,
    "promptId": prompt_id,
    "liveWpm": live_wpm,
    "ranked": ranked,
    "userId": user_id
  } | tojson }}
</script>
<script src="/static/app.js"></script>
{% endblock %}
